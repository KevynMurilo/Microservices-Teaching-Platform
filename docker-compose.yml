# =============================================================================
# Docker Compose: INFRASTRUCTURE ONLY
# This file provides the external dependencies for local development.
# Run with: docker-compose up -d
# =============================================================================

services:

  # ---------------------------------------------------------------------------
  # MESSAGING (RabbitMQ)
  # ---------------------------------------------------------------------------
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: flash-rabbitmq
    ports:
      - "5672:5672"     # Protocolo AMQP (seu app conecta aqui)
      - "15672:15672"   # UI de Gerenciamento (http://localhost:15672)
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---------------------------------------------------------------------------
  # DATABASES (PostgreSQL)
  # ---------------------------------------------------------------------------
  order-db:
    image: postgres:16-alpine
    container_name: flash-order-db
    environment:
      POSTGRES_DB: orderdb
      POSTGRES_USER: order_user
      POSTGRES_PASSWORD: order_pass
    ports:
      - "5433:5432"
    volumes:
      - order-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U order_user -d orderdb"]
      interval: 5s
      timeout: 3s
      retries: 5

  payment-db:
    image: postgres:16-alpine
    container_name: flash-payment-db
    environment:
      POSTGRES_DB: paymentdb
      POSTGRES_USER: payment_user
      POSTGRES_PASSWORD: payment_pass
    ports:
      - "5434:5432"
    volumes:
      - payment-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U payment_user -d paymentdb"]
      interval: 5s
      timeout: 3s
      retries: 5

  notification-db:
    image: postgres:16-alpine
    container_name: flash-notification-db
    environment:
      POSTGRES_DB: notificationdb
      POSTGRES_USER: notification_user
      POSTGRES_PASSWORD: notification_pass
    ports:
      - "5435:5432"
    volumes:
      - notification-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U notification_user -d notificationdb"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ---------------------------------------------------------------------------
  # OBSERVABILITY (Jaeger, Prometheus, Grafana)
  # ---------------------------------------------------------------------------
  jaeger:
    image: jaegertracing/all-in-one:1.57
    container_name: flash-jaeger
    ports:
      - "16686:16686"   # UI (http://localhost:16686)
      - "4318:4318"     # OTLP HTTP (seu app envia spans para c√°)
    environment:
      COLLECTOR_OTLP_ENABLED: "true"

  prometheus:
    image: prom/prometheus:v2.51.0
    container_name: flash-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./infra/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro

  grafana:
    image: grafana/grafana:10.4.0
    container_name: flash-grafana
    ports:
      - "3000:3000"     # admin / admin
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
    volumes:
      - grafana-data:/var/lib/grafana
      - ./infra/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./infra/grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      - prometheus

volumes:
  order-db-data:
  payment-db-data:
  notification-db-data:
  grafana-data: